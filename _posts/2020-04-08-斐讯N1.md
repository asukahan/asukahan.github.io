---

layout:     post
title:      斐讯N1盒子刷OpenWRT以及Trojan上网
subtitle:   没有翻不过去的墙
date:       2020-04-08
author:     Asukahan
header-img: img/abstract-4626114_1920.jpg
catalog: true
tags:
    - GFW
    - OpenWRT
    - Phicomm

---



![N1](https://raw.githubusercontent.com/Pockies/pic/master/741f9461ly1g0u2heavhxj212w0pyx6p.jpg)


斐讯N1盒子作为电视盒子里的战斗机，拼多多上收一个走起来，接近全新成色。
今天等到晚上快睡觉了，突然发现快递在门口放着……打开，刷！

## 概念

用白话讲，旁路由就是在主路由器旁边工作的路由，主路由分出一部分事给旁路由来做，我们这个案例中，这些事就是：

* DHCP服务器：给局域网内的机器分IP地址。
* 子网关：对外流量先通过旁路由再进主路由。
* 科学上网：给局域网内机器提供SS/SSR/V2Ray/Trojan科学上网服务。

## 刷机准备工作

1. 下[Etcher](https://www.balena.io/etcher/)是肯定的，其他的像[HDD Raw Copy Tool](https://hddguru.com/software/HDD-Raw-Copy-Tool/)也行，只要是写镜像的玩意就行，没有一定之规，推荐用Etcher。 
2. 下固件，我这里推荐27+版本的恩山的flippy的固件，[地址](https://pan.baidu.com/s/1p3NNRhwhvGDWdqtxCarjSw) 提取码:v4j3 下载完成之后解压到本地得到img文件。
3. 插上一个4G以上的，最好大点的U盘，别用乱七八糟牌子的青花瓷超市积分换的U盘。
4. 打开etcher，选中解压完成的img文件，U盘应该已经自己选定了，点Flash！
![写磁盘镜像](http://47.105.183.69/img/post-phicommn1/etcher.png)
5. 写完之后macOS下的etcher会自动弹出，别的系统或者软件，如果写完之后没弹出，弹出之后再拔U盘。
6. 固件的默认IP地址是192.168.1.1，请做好同样网段地址的规避，要不就拿一台完全脱离开目前局域网的电脑来做刷机工作。意思就是，**拿一台笔记本，不接wifi，网线一头接到N1盒子，另一头先不接电脑，等盒子启动好了再接！**
7. 建议先确认主路由网段，调节成类似`192.168.129.1`这种，大部分路由器的调节方法是在路由器地址。
![](http://47.105.183.69/img/post-phicommn1/net.png)

## 上机
1. 插U盘到盒子上，通电启动盒子，喜欢玩的可以接HDMI看看屏幕跑码，等3分钟左右不跑了之后，网线接到电脑上。
2. **确定此电脑能Ping通192.168.1.1，通了之后再做下面的步骤。**
3. 浏览器打开192.168.1.1，用户名：root 密码：password
![](http://47.105.183.69/img/post-phicommn1/title.png)

4. 登进去之后应该是这样的：
![](http://47.105.183.69/img/post-phicommn1/main.png)

5. 找到左边 **网络** --> **接口** --> **LAN** ，点击LAN的**编辑**按钮。
![](http://47.105.183.69/img/post-phicommn1/edit.png)

6. **下面这些步骤比较关键，建议预读三个步骤再操作。** 在LAN的接口编辑页面中，填入跟主路由器一样的网段的静态IP地址。我这里主路由的网段是129，根据你们自己家的情况填入对应的网段下的空余IP，就是别跟网内任何机器IP冲突！
然后在**网关**处填入**主路由地址**，就是告诉旁路由**你丫也要从主路由上网**！DNS随便，114的挺好使。此处禁用IPv6。
![](http://47.105.183.69/img/post-phicommn1/lan.png)

7. 向下滚动页面，设置旁路由为DHCP服务器：
![](http://47.105.183.69/img/post-phicommn1/dhcp.png)
注意最下面的3和6后面的是英文的逗号`,` 后面跟着的是上面设置过的这个旁路由的地址。在后一个DHCP服务器tab中禁用和IPv6相关的一切，并且这步之后也要禁用看到的一切跟IPv6相关，因为IPv6网关并没有指派，如果主路由分了IPv6的地址并成为IPv6网关，那么旁路由会控制不了IPv6的相关发送，导致科学上网的问题。

8. 关掉主路由的DHCP服务器：
![](http://47.105.183.69/img/post-phicommn1/dhcpoff.png)

这步做完之后，你的两个路由器就**必须配合起来才能上网！** 切记不能只开一个：

* 只开旁路由能给电脑分IP，但是不能上网
* 只开主路由，主路由能上网，但是主路由没有分配IP的功能，所以网内电脑会没有IP，上不了网。
* 如果之后需要只用主路由，需要给电脑手动指定一个IP之后，登到主路由器上，再打开主路由器的DHCP服务器。


**重启两个路由器，必须重启**

**重启两个路由器，必须重启**
 
**重启两个路由器，必须重启**


## 科学上网

在完成以上步骤之后，你的两个路由应该能给内网之内的机器提供上网服务了。这时候就可以使用正常接入内网的电脑进行操作了，**建议操作之前把电脑也重启一下**，换DHCP服务器会重新分配内网IP。

1. 浏览器登录旁路由，进入左边的**服务** --> **ShadowsocksR Plus+** --> **服务器节点**，滚动到最下面，选择**添加**
![](http://47.105.183.69/img/post-phicommn1/trojan.png)

2. 买的机场的话，应该在服务提供上那边会提供以`trojan://` 开头的地址，直接选择**导入配置信息**就可以。手填的话，Trojan的配置比较简单，只需要填**服务器地址**，**端口号**一般是443，**密码**，这三个就行。本地端口随便设置，之后点击**保存&应用**。
![](http://47.105.183.69/img/post-phicommn1/trojannode.png)

3. 完成之后进入上面**状态**的tab，更新GFWlist之类的库：
![](http://47.105.183.69/img/post-phicommn1/gfw.png)

4. 返回SSR的第一个tab**客户端**，选择刚刚添加的Trojan服务器，按照需要选择自己的服务。别忘了点击**保存&应用**。
![](http://47.105.183.69/img/post-phicommn1/trojansetting.png)

5. 旁路由的话，需要加自定义防火墙规则，SSH登上路由之后，运行：

`iptables -t nat -I POSTROUTING -o eth0 -j MASQUERADE`

**重启旁路由**

**重启旁路由**

**重启旁路由**

## 可选步骤
SSH登录上路由器之后，可以运行自带脚本，写文件到内部emmc:

*  在命令提示符下输入 `./inst-to-emmc.sh` （打到inst的时候按tab键就会自动补全），回车。
*  输入y继续

![](http://47.105.183.69/img/post-phicommn1/toemmc.png)


## 结语
至此，内网之内的所有终端都应该可以正常科学上网了，我也深深的感觉到这个N1的虎逼之处……准备再买几个替换掉家里所有的待机终端：

* Rush固件电视盒子
* Volumio音乐服务
* 下载机

……

感到了Arm对x86深深的恶意……


